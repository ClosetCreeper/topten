<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TopTen - Trip Share</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.js"></script>
    <style>
        /* All your CSS styles remain unchanged */
        /* ... */
    </style>
</head>
<body>
    <div class="floating-elements">
        <div class="floating-circle"></div>
        <div class="floating-circle"></div>
        <div class="floating-circle"></div>
    </div>

    <div class="container">
        <div class="hero">
            <h1>TopTen</h1>
            <p class="hero-subtitle">Share your adventures with the world</p>
        </div>

        <div id="content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading your amazing trip...</p>
            </div>
        </div>

        <div class="powered-by">
            <p>Powered by TopTen â€¢ KeyNine Studios</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://idasmhlbftmhxibrjqjw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkYXNtaGxiZnRtaHhpYnJqcWp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNDA2NzMsImV4cCI6MjA2NzkxNjY3M30.aWcHB8Aalo4_1APEjXs-3Ag6dOMbomr95T_Tj4BUUdc';
        const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function showError(message) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="error">
                    <h3>Oops! Something went wrong</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        function displayTrip(trip) {
            const content = document.getElementById('content');
            content.innerHTML = '';
            window.carouselData = trip.categories.map(cat => ({
                locations: cat.locations || [],
                captions: cat.captions || []
            }));

            const card = document.createElement('div');
            card.className = 'trip-card';

            const header = document.createElement('div');
            header.className = 'trip-header';

            const title = document.createElement('div');
            title.className = 'trip-title';
            title.textContent = trip.tripName;

            const date = document.createElement('div');
            date.className = 'trip-date';
            date.textContent = new Date(trip.tripDate).toLocaleDateString();

            header.appendChild(title);
            header.appendChild(date);

            const stats = document.createElement('div');
            stats.className = 'trip-stats';
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${trip.milesWalked.toFixed(1)} mi</div>
                    <div class="stat-label">Miles Walked</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${trip.photoCount}</div>
                    <div class="stat-label">Photos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${trip.categories.length}</div>
                    <div class="stat-label">Categories</div>
                </div>
            `;

            const catSection = document.createElement('div');
            catSection.className = 'categories-section';

            const sectionTitle = document.createElement('h2');
            sectionTitle.className = 'section-title';
            sectionTitle.textContent = 'Trip Highlights';

            const grid = document.createElement('div');
            grid.className = 'categories-grid';

            trip.categories.forEach((cat, index) => {
                const catCard = document.createElement('div');
                catCard.className = 'category-card';

                const carouselContainer = document.createElement('div');
                carouselContainer.className = 'carousel-container';
                carouselContainer.id = `carousel-${index}`;

                const track = document.createElement('div');
                track.className = 'carousel-track';

                cat.photoURLs.forEach((url, i) => {
                    const img = document.createElement('img');
                    img.className = 'carousel-image';
                    img.src = url;
                    img.alt = `Photo ${i + 1}`;
                    track.appendChild(img);
                });

                carouselContainer.appendChild(track);

                const imageCounter = document.createElement('div');
                imageCounter.className = 'image-counter';
                imageCounter.textContent = `${cat.photoURLs.length} photo${cat.photoURLs.length > 1 ? 's' : ''}`;
                carouselContainer.appendChild(imageCounter);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'category-content';

                const name = document.createElement('div');
                name.className = 'category-name';
                name.textContent = cat.categoryName;

                const loc = document.createElement('div');
                loc.className = 'category-location';
                loc.textContent = cat.location;

                contentDiv.appendChild(name);
                contentDiv.appendChild(loc);

                const captionsContainer = document.createElement('div');
                captionsContainer.className = 'captions-container';
                contentDiv.appendChild(captionsContainer);

                catCard.appendChild(carouselContainer);
                catCard.appendChild(contentDiv);
                grid.appendChild(catCard);
            });

            catSection.appendChild(sectionTitle);
            catSection.appendChild(grid);

            card.appendChild(header);
            card.appendChild(stats);
            card.appendChild(catSection);
            content.appendChild(card);
        }

        function initializeCarousel(index, imageCount) {
            const container = document.getElementById(`carousel-${index}`);
            if (!container) return;

            const track = container.querySelector('.carousel-track');
            const categoryCard = container.closest('.category-card');
            const locationElement = categoryCard.querySelector('.category-location');
            const captionsContainer = categoryCard.querySelector('.captions-container');
            let currentIndex = 0;

            const category = window.carouselData[index];

            function updateContent() {
                if (category.locations && category.locations[currentIndex]) {
                    locationElement.textContent = category.locations[currentIndex];
                }
                if (captionsContainer) {
                    captionsContainer.innerHTML = '';
                    if (category.captions && category.captions[currentIndex] && category.captions[currentIndex].trim() !== '') {
                        const captionDiv = document.createElement('div');
                        captionDiv.className = 'caption-item';
                        captionDiv.textContent = `"${category.captions[currentIndex]}"`;
                        captionsContainer.appendChild(captionDiv);
                    }
                }
            }

            function updateSlide() {
                track.style.transform = `translateX(-${currentIndex * 100}%)`;
            }

            if (imageCount > 1) {
                const prevButton = document.createElement('button');
                const nextButton = document.createElement('button');

                prevButton.innerHTML = '&#10094;';
                nextButton.innerHTML = '&#10095;';
                prevButton.className = 'carousel-nav prev';
                nextButton.className = 'carousel-nav next';

                prevButton.onclick = () => {
                    if (currentIndex > 0) {
                        currentIndex--;
                        updateSlide();
                        updateContent();
                    }
                };
                nextButton.onclick = () => {
                    if (currentIndex < imageCount - 1) {
                        currentIndex++;
                        updateSlide();
                        updateContent();
                    }
                };

                container.appendChild(prevButton);
                container.appendChild(nextButton);
            }

            updateContent();
        }

        function getTripIdFromUrl() {
            const pathParts = window.location.pathname.split('/');
            const tripsIndex = pathParts.indexOf('trip');
            if (tripsIndex !== -1 && tripsIndex < pathParts.length - 1) {
                return pathParts[tripsIndex + 1];
            }
            return null;
        }

        async function loadTrip() {
            const tripId = getTripIdFromUrl();
            if (!tripId) return showError('Invalid trip URL.');

            try {
                const { data: trip } = await supabase
                    .from('trips')
                    .select('*')
                    .eq('trip_id', tripId)
                    .single();

                const { data: categories } = await supabase
                    .from('trip_categories')
                    .select('*')
                    .eq('trip_id', tripId);

                const { data: routeRows } = await supabase
                    .from('trip_routes')
                    .select('*')
                    .eq('trip_id', tripId)
                    .order('created_at', { ascending: false })
                    .limit(1);

                const routeData = routeRows?.[0]?.route_data || [];

                const groupedCategories = {};
                categories.forEach(cat => {
                    if (!groupedCategories[cat.category_name]) {
                        groupedCategories[cat.category_name] = {
                            categoryName: cat.category_name,
                            location: cat.location_name,
                            locations: [],
                            coordinates: {
                                latitude: parseFloat(cat.latitude),
                                longitude: parseFloat(cat.longitude)
                            },
                            photoURLs: [],
                            captions: []
                        };
                    }
                    groupedCategories[cat.category_name].photoURLs.push(cat.photo_url);
                    groupedCategories[cat.category_name].locations.push(cat.location_name);
                    groupedCategories[cat.category_name].captions.push(cat.caption?.trim() || null);
                });

                const transformedTrip = {
                    tripId: trip.trip_id,
                    tripName: trip.trip_name,
                    tripDate: trip.trip_date,
                    milesWalked: trip.miles_walked,
                    photoCount: trip.photo_count,
                    userId: trip.user_id,
                    routeData: routeData,
                    categories: Object.values(groupedCategories)
                };

                displayTrip(transformedTrip);

                transformedTrip.categories.forEach((category, index) => {
                    initializeCarousel(index, category.photoURLs.length);
                });

                // Optionally load map if needed
            } catch (err) {
                console.error(err);
                showError('Failed to load trip: ' + err.message);
            }
        }

        document.addEventListener('DOMContentLoaded', loadTrip);
    </script>
</body>
</html>
