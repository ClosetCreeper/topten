<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trip Page</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9fb;
      color: #333;
    }
    header {
      background: #4CAF50;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 2em;
    }
    #progress {
      margin: 20px auto;
      padding: 15px;
      max-width: 900px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .category {
      margin: 30px auto;
      max-width: 900px;
    }
    .category h2 {
      margin-bottom: 10px;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
      color: #4CAF50;
    }
    .photos {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    .photo-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }
    .photo-card:hover {
      transform: scale(1.02);
    }
    .photo-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }
    .caption {
      padding: 10px;
      font-size: 0.9em;
      background: #fafafa;
    }
  </style>
</head>
<body>
  <header>
    <h1 id="place-name">Loading...</h1>
    <p id="user-name"></p>
  </header>

  <div id="progress"></div>
  <div id="categories"></div>

  <script>
    // === CloudKit Setup ===
    document.addEventListener("DOMContentLoaded", async () => {
      if (!window.CloudKit) {
        console.error("CloudKit library not found. Make sure CloudKit JS is embedded here if needed.");
        return;
      }

      CloudKit.configure({
        containers: [{
          containerIdentifier: "iCloud.com.keyninestudios.TopTen",
          apiTokenAuth: {
            apiToken: "YOUR_API_TOKEN_HERE", // replace with your CloudKit API token
            persist: true
          },
          environment: "development" // or "production"
        }]
      });

      const container = CloudKit.getDefaultContainer();
      const database = container.publicCloudDatabase;

      try {
        // Example fetch for one place â€” adjust query for your use case
        let placeResp = await database.performQuery({ recordType: "Place" });
        let photoResp = await database.performQuery({ recordType: "PhotoEntry" });
        let userResp  = await database.performQuery({ recordType: "User" });
        let progressResp = await database.performQuery({ recordType: "Progress" });

        const place = placeResp.records[0];
        const user = userResp.records[0];
        const progress = progressResp.records[0];
        const photos = photoResp.records;

        // Fill header
        document.getElementById("place-name").innerText = place.fields.name.value;
        document.getElementById("user-name").innerText = "Explorer: " + user.fields.username.value;

        // Progress
        document.getElementById("progress").innerHTML = `
          <h2>Progress</h2>
          <p>Days Explored: ${progress.fields.daysExplored.value}</p>
          <p>Miles Walked: ${progress.fields.milesWalked.value}</p>
        `;

        // Categories
        const categoriesDiv = document.getElementById("categories");
        const grouped = {};
        photos.forEach(p => {
          const cat = p.fields.category.value;
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(p);
        });

        for (const [cat, entries] of Object.entries(grouped)) {
          const section = document.createElement("div");
          section.className = "category";
          section.innerHTML = `<h2>${cat}</h2><div class="photos"></div>`;
          const photosDiv = section.querySelector(".photos");

          entries.forEach(entry => {
            const card = document.createElement("div");
            card.className = "photo-card";
            card.innerHTML = `
              <img src="${entry.fields.photoData.value.downloadURL}" alt="">
              <div class="caption">${entry.fields.caption.value}</div>
            `;
            photosDiv.appendChild(card);
          });

          categoriesDiv.appendChild(section);
        }

      } catch (err) {
        console.error("Error fetching data:", err);
        document.body.innerHTML = "<p style='color:red; text-align:center;'>Error loading trip data.</p>";
      }
    });
  </script>
</body>
</html>
