<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudKit Trip Viewer</title>
    <script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        .trip { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .trip h2 { margin: 0; font-size: 1.2em; }
        .trip p { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Trip Details</h1>
    <div id="trip-container"></div>

    <script>
        // Initialize CloudKit
        CloudKit.configure({
            containers: [{
                containerIdentifier: 'iCloud.keyninestudios.topten',
                apiTokenAuth: {
                    apiToken: '1bab850cbdcaffa45d64df96aa7ac56781f0028a3f34dddb58276819a7859e59',
                    persist: true
                },
                environment: 'development'
            }]
        });

        // Function to load trip data
        async function loadTrip(tripId) {
            try {
                const db = CloudKit.getDefaultContainer().setUpDatabase();

                // Fetch the trip record
                const tripResponse = await db.fetchRecords([tripId]);
                if (tripResponse.hasErrors) {
                    throw new Error('Failed to fetch trip data: ' + tripResponse.errors[0].message);
                }

                const trip = tripResponse.records[0];
                const userRef = trip.fields.user?.value;
                const placeRef = trip.fields.place?.value;

                // Validate reference fields
                if (!userRef || !userRef.recordName) {
                    throw new Error("User reference missing recordName");
                }
                if (!placeRef || !placeRef.recordName) {
                    throw new Error("Place reference missing recordName");
                }

                // Fetch user and place records
                const [userResponse, placeResponse] = await Promise.all([
                    db.fetchRecords([userRef.recordName]),
                    db.fetchRecords([placeRef.recordName])
                ]);

                if (userResponse.hasErrors || placeResponse.hasErrors) {
                    throw new Error('Failed to fetch user/place data');
                }

                const user = userResponse.records[0];
                const place = placeResponse.records[0];

                // Query for Top10PhotoEntries
                const photosQuery = await db.performQuery({
                    recordType: 'Top10PhotoEntries',
                    filterBy: [
                        { fieldName: 'user', comparator: 'EQUALS', fieldValue: { value: user.recordName } },
                        { fieldName: 'place', comparator: 'EQUALS', fieldValue: { value: place.recordName } }
                    ]
                });

                if (photosQuery.hasErrors) {
                    throw new Error('Failed to fetch photos: ' + photosQuery.errors[0].message);
                }

                const photos = photosQuery.records;

                // Display the trip details
                const tripContainer = document.getElementById('trip-container');
                tripContainer.innerHTML = `
                    <div class="trip">
                        <h2>${trip.fields.title}</h2>
                        <p><strong>User:</strong> ${user.fields.name}</p>
                        <p><strong>Place:</strong> ${place.fields.name}</p>
                        <p><strong>Photos:</strong></p>
                        <ul>
                            ${photos.map(photo => `<li>${photo.fields.title}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading trip:', error);
                document.getElementById('trip-container').innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }

        // Example: Load trip with ID 'EA35C155-F2C3-4478-9B81-279DA9CAAF6A'
        loadTrip('EA35C155-F2C3-4478-9B81-279DA9CAAF6A');
    </script>
</body>
</html>
