<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Top 10 Trip API</title>
</head>
<body>
<script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
<script>
  CloudKit.configure({
    containers: [{
      containerIdentifier: 'iCloud.keyninestudios.topten',
      apiTokenAuth: { apiToken: '1bab850cbdcaffa45d64df96aa7ac56781f0028a3f34dddb58276819a7859e59' },
      environment: 'development'
    }]
  });

  const db = CloudKit.getDefaultContainer().publicCloudDatabase;

  async function fetchTripData(tripId) {
    try {
      if (!tripId) throw new Error('No trip ID provided');

      // 1. Fetch Top10UserProgress by recordName
      const progressRes = await db.fetchRecords({ recordNames: [tripId] });
      const progress = progressRes.records[0];
      if (!progress) throw new Error('Trip not found');

      const userRef = progress.fields.user.value.recordName;
      const placeRef = progress.fields.place.value.recordName;

      // 2. Fetch Top10Places record
      const placeRes = await db.fetchRecords({ recordNames: [placeRef] });
      const place = placeRes.records[0];

      // 3. Fetch AppUsers record
      const userRes = await db.fetchRecords({ recordNames: [userRef] });
      const user = userRes.records[0];

      // 4. Query Top10PhotoEntries for this user and place
      const photoQuery = await db.performQuery({
        recordType: 'Top10PhotoEntries',
        filterBy: [
          { fieldName: 'user', comparator: 'EQUALS', fieldValue: { value: { recordName: userRef, type: 'REFERENCE' } } },
          { fieldName: 'place', comparator: 'EQUALS', fieldValue: { value: { recordName: placeRef, type: 'REFERENCE' } } }
        ]
      });

      // 5. Group photos by category
      const categories = {};
      photoQuery.records.forEach(photo => {
        const category = photo.fields.category.value;
        if (!categories[category]) {
          categories[category] = { categoryName: category, photoURLs: [], captions: [], locations: [], coordinates: {} };
        }
        const asset = photo.fields.photoData.value;
        const base64Image = asset ? asset.downloadURL : null; // You can replace with base64 if needed
        categories[category].photoURLs.push(base64Image);
        categories[category].captions.push(photo.fields.caption?.value || '');
        categories[category].locations.push(''); // optional: fill with location data if available
        categories[category].coordinates = {
          latitude: place.fields.latitude.value,
          longitude: place.fields.longitude.value
        };
      });

      // 6. Build response
      const response = {
        tripId: progress.recordName,
        tripName: `${place.fields.name.value}, ${place.fields.state.value}, ${place.fields.country.value}`,
        tripDate: progress.fields.createdAt.value,
        milesWalked: 0, // optional: calculate if you store distance
        photoCount: photoQuery.records.length,
        userId: user.recordName,
        username: user.fields.username.value,
        routeData: [], // optional: add route data if stored
        categories: Object.values(categories)
      };

      console.log(JSON.stringify(response, null, 2));
      return response;

    } catch (err) {
      console.error('Error loading trip:', err);
      return { error: err.message };
    }
  }

  // Example usage: parse URL param and fetch trip
  const urlParams = new URLSearchParams(window.location.search);
  const tripId = urlParams.get('trip');
  fetchTripData(tripId);
</script>
</body>
</html>
