<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Top 10 Trip Viewer</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh;color:#333;margin:0;padding:20px;}
  .container {max-width:600px;margin:0 auto;}
  h1 {text-align:center;color:white;}
  .trip-card {background:rgba(255,255,255,0.95);border-radius:15px;padding:15px;margin-bottom:15px;box-shadow:0 10px 25px rgba(0,0,0,0.1);}
  .trip-card h2 {margin:0;font-size:1.2rem;}
  .trip-card p {margin:5px 0;}
</style>
</head>
<body>
<div class="container">
  <h1>Trip Details</h1>
  <div id="trip-container">Loading...</div>
</div>

<script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
<script>
  CloudKit.configure({
    containers: [{
      containerIdentifier: 'iCloud.keyninestudios.topten',
      apiTokenAuth: { apiToken: '1bab850cbdcaffa45d64df96aa7ac56781f0028a3f34dddb58276819a7859e59' },
      environment: 'development'
    }]
  });

  const db = CloudKit.getDefaultContainer().publicCloudDatabase;

  async function loadTrip(tripId) {
    try {
      const tripResponse = await db.fetchRecords([tripId]);
      if(tripResponse.hasErrors) throw new Error(tripResponse.errors[0].message);
      const trip = tripResponse.records[0];

      if(!trip.fields.user?.value?.recordName) throw new Error("User reference missing recordName");
      if(!trip.fields.place?.value?.recordName) throw new Error("Place reference missing recordName");

      const [userResp, placeResp] = await Promise.all([
        db.fetchRecords([trip.fields.user.value.recordName]),
        db.fetchRecords([trip.fields.place.value.recordName])
      ]);

      const user = userResp.records[0];
      const place = placeResp.records[0];

      const photosQuery = await db.performQuery({
        recordType: 'Top10PhotoEntries',
        filterBy: [
          { fieldName: 'user', comparator: 'EQUALS', fieldValue: { value: { recordName: user.recordName, type:"REFERENCE"} } },
          { fieldName: 'place', comparator: 'EQUALS', fieldValue: { value: { recordName: place.recordName, type:"REFERENCE"} } }
        ]
      });

      const photos = photosQuery.records;

      const container = document.getElementById('trip-container');
      container.innerHTML = `
        <div class="trip-card">
          <h2>${trip.fields.title || "Trip"}</h2>
          <p><strong>User:</strong> ${user.fields.name}</p>
          <p><strong>Place:</strong> ${place.fields.name}</p>
          <p><strong>Photos:</strong></p>
          <ul>${photos.map(p=>`<li>${p.fields.title}</li>`).join('')}</ul>
        </div>
      `;
    } catch(e) {
      console.error(e);
      document.getElementById('trip-container').innerHTML = `<p>Error: ${e.message}</p>`;
    }
  }

  // Replace with your actual trip record ID
  loadTrip('EA35C155-F2C3-4478-9B81-279DA9CAAF6A');
</script>
</body>
</html>
