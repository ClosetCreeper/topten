<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Top 10 Trip</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .hero {
    text-align: center;
    padding: 60px 0;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    margin-bottom: 40px;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .hero h1 {
    font-size: 3.5em;
    font-weight: 700;
    background: linear-gradient(45deg, #fff, #f0f0f0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 20px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .hero-subtitle {
    font-size: 1.2em;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 30px;
  }

  .trip-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 24px;
    padding: 40px;
    margin-bottom: 30px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .trip-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
  }

  .trip-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
  }

  .trip-title {
    font-size: 2.5em;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 10px;
  }

  .trip-date {
    font-size: 1.1em;
    color: #7f8c8d;
    font-weight: 500;
  }

  .trip-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .stat-card {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 16px;
    padding: 25px;
    text-align: center;
    transition: transform 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  .stat-card:hover {
    transform: scale(1.05);
  }

  .stat-number {
    font-size: 2.5em;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 8px;
  }

  .stat-label {
    font-size: 0.9em;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
  }

  .categories-section {
    margin-bottom: 40px;
  }

  .section-title {
    font-size: 2em;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 25px;
    text-align: center;
  }

  .categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
  }

  .category-card {
    background: #fff;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .category-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }

  .carousel-container {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;
    border-radius: 16px 16px 0 0;
  }

  .carousel-track {
    display: flex;
    transition: transform 0.5s ease;
    height: 100%;
  }

  .carousel-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    flex-shrink: 0;
    transition: transform 0.3s ease;
  }

  .category-card:hover .carousel-image {
    transform: scale(1.05);
  }

  .carousel-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.3s ease;
    z-index: 10;
  }

  .carousel-nav:hover {
    background: rgba(0, 0, 0, 0.7);
    transform: translateY(-50%) scale(1.1);
  }

  .carousel-nav.prev {
    left: 10px;
  }

  .carousel-nav.next {
    right: 10px;
  }

  .carousel-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .carousel-nav:disabled:hover {
    background: rgba(0, 0, 0, 0.5);
    transform: translateY(-50%) scale(1);
  }

  .image-counter {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 500;
  }

  .category-content {
    padding: 25px;
  }

  .category-name {
    font-size: 1.3em;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 10px;
  }

  .captions-container {
    margin-top: 15px;
  }

  .caption-item {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 3px solid #667eea;
    font-style: italic;
    color: #495057;
    font-size: 0.9em;
    transition: all 0.3s ease;
  }

  .caption-item:hover {
    background: #e9ecef;
    transform: translateX(5px);
  }

  .loading {
    text-align: center;
    padding: 80px 20px;
    color: rgba(255, 255, 255, 0.8);
  }

  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .error {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    color: #e74c3c;
    font-size: 1.1em;
  }

  @media (max-width: 768px) {
    .hero h1 {
      font-size: 2.5em;
    }
    
    .trip-title {
      font-size: 2em;
    }
    
    .trip-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .categories-grid {
      grid-template-columns: 1fr;
    }
    
    .trip-stats {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
</head>
<body>
<div class="container">
  <div class="hero">
    <h1>Top 10 Trip Details</h1>
    <p class="hero-subtitle">Your amazing adventure</p>
  </div>
  
  <div id="trip-content">
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Loading trip details...</p>
    </div>
  </div>
</div>

<script>
// Function to handle CloudKit CKAsset data
function createImageUrl(photoAsset) {
  // Simply return the downloadURL directly - no processing needed
  if (photoAsset && photoAsset.downloadURL) {
    return photoAsset.downloadURL;
  }
  return null;
}

function initializeCarousel(categoryElement, photos) {
  const container = categoryElement.querySelector('.carousel-container');
  const track = container.querySelector('.carousel-track');
  const imageCounter = container.querySelector('.image-counter');
  const captionsContainer = categoryElement.querySelector('.captions-container');
  
  let currentIndex = 0;
  const totalImages = photos.length;

  function updateCarousel() {
    // Update image position
    track.style.transform = `translateX(-${currentIndex * 100}%)`;
    
    // Update counter
    imageCounter.textContent = `${currentIndex + 1} of ${totalImages}`;
    
    // Update caption
    captionsContainer.innerHTML = '';
    const currentPhoto = photos[currentIndex];
    if (currentPhoto.caption && currentPhoto.caption.trim()) {
      const captionDiv = document.createElement('div');
      captionDiv.className = 'caption-item';
      captionDiv.textContent = currentPhoto.caption;
      captionsContainer.appendChild(captionDiv);
    }
  }

  // Add navigation buttons only if there's more than one image
  if (totalImages > 1) {
    const prevButton = document.createElement('button');
    prevButton.className = 'carousel-nav prev';
    prevButton.innerHTML = '&#10094;';
    prevButton.onclick = () => {
      currentIndex = currentIndex > 0 ? currentIndex - 1 : totalImages - 1;
      updateCarousel();
    };

    const nextButton = document.createElement('button');
    nextButton.className = 'carousel-nav next';
    nextButton.innerHTML = '&#10095;';
    nextButton.onclick = () => {
      currentIndex = currentIndex < totalImages - 1 ? currentIndex + 1 : 0;
      updateCarousel();
    };

    container.appendChild(prevButton);
    container.appendChild(nextButton);
  }

  // Initialize
  updateCarousel();
}

async function loadTrip(tripScheme) {
  try {
    const res = await fetch(`/api/tripapi?tripScheme=${tripScheme}`);
    const data = await res.json();
    
    if (data.error) {
      document.getElementById('trip-content').innerHTML = `
        <div class="error">
          <h3>Oops! Something went wrong</h3>
          <p>${data.error}</p>
        </div>
      `;
      return;
    }

    // Format completed date
    const completedDate = data.completedAt ? 
      new Date(data.completedAt).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      }) : 'Not completed';

    // Build the trip card
    let html = `
      <div class="trip-card">
        <div class="trip-header">
          <div>
            <div class="trip-title">${data.username}'s Trip</div>
            <div class="trip-date">${data.placeName}</div>
          </div>
          <div class="trip-date">${completedDate}</div>
        </div>
        
        <div class="trip-stats">
          <div class="stat-card">
            <div class="stat-number">${data.photoCount}</div>
            <div class="stat-label">Photos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.categories.length}</div>
            <div class="stat-label">Categories</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${data.completedCategories.length}</div>
            <div class="stat-label">Completed</div>
          </div>
        </div>
    `;

    // Add photo categories if any exist
    if (data.categories && data.categories.length > 0) {
      html += `
        <div class="categories-section">
          <h2 class="section-title">Trip Highlights</h2>
          <div class="categories-grid">
      `;
      
      data.categories.forEach((cat, index) => {
        html += `
          <div class="category-card" data-category-index="${index}">
            <div class="carousel-container">
              <div class="carousel-track">
        `;
        
        // Add images to carousel
        cat.photos.forEach(photo => {
          if (photo.photo && photo.photo.downloadURL) {
            html += `
              <img class="carousel-image" src="${photo.photo.downloadURL}" alt="${cat.categoryName}" loading="lazy" />
            `;
          }
        });
        
        html += `
              </div>
              <div class="image-counter">${cat.photos.length} photo${cat.photos.length > 1 ? 's' : ''}</div>
            </div>
            <div class="category-content">
              <div class="category-name">${cat.categoryName}</div>
              <div class="captions-container"></div>
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
        </div>
      `;
    } else {
      html += `
        <div class="section-title">No photos found for this trip.</div>
      `;
    }

    html += `</div>`; // Close trip-card

    document.getElementById('trip-content').innerHTML = html;

    // Store trip data globally for modal access
    window.tripData = data;

    // Initialize carousels for each category
    data.categories.forEach((cat, index) => {
      const categoryElement = document.querySelector(`[data-category-index="${index}"]`);
      if (categoryElement && cat.photos.length > 0) {
        initializeCarousel(categoryElement, cat.photos, index);
      }
    });

  } catch (err) {
    document.getElementById('trip-content').innerHTML = `
      <div class="error">
        <h3>Error loading trip</h3>
        <p>${err.message}</p>
      </div>
    `;
    console.error(err);
  }
}

// Get tripScheme from URL parameters or use default
function getTripSchemeFromUrl() {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get('tripScheme') || 'k1000';
}

// Load trip when page loads
document.addEventListener('DOMContentLoaded', () => {
  const tripScheme = getTripSchemeFromUrl();
  loadTrip(tripScheme);
});
</script>
</body>
</html>
