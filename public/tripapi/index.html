<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TopTen - Trip Share</title>
<script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
<style>
/* keep your previous styles here */
</style>
</head>
<body>
<div class="container">
  <div class="hero">
    <h1 id="place-name">TopTen</h1>
    <p class="hero-subtitle" id="trip-subtitle">Share your adventures with the world</p>
  </div>
  <div id="content">
    <div class="loading">
      <div class="loading-spinner"></div>
      <p>Loading your amazing trip...</p>
    </div>
  </div>
  <div class="powered-by"><p>Powered by TopTen â€¢ KeyNine Studios</p></div>
</div>

<script>
CloudKit.configure({
  containers: [{
    containerIdentifier: "iCloud.keyninestudios.topten",
    apiTokenAuth: { apiToken: "1bab850cbdcaffa45d64df96aa7ac56781f0028a3f34dddb58276819a7859e59", persist: true },
    environment: "development"
  }]
});

async function loadTrip() {
  const container = CloudKit.getDefaultContainer();
  const db = container.publicCloudDatabase;

  const tripId = new URLSearchParams(window.location.search).get('trip');
  if (!tripId) {
    document.getElementById("content").innerHTML = `<div class="error">No trip specified in URL</div>`;
    return;
  }

  try {
    // Fetch Top10UserProgress by recordName (array of strings!)
    const progressResult = await db.fetchRecords({ recordNames: [tripId] });
    const progressRecord = progressResult.records[0];
    if (!progressRecord) throw new Error("Trip not found");

    // Resolve user and place references
    const userRecordName = progressRecord.fields.user?.value?.recordName;
    const placeRecordName = progressRecord.fields.place?.value?.recordName;
    if (!userRecordName || !placeRecordName) throw new Error("Missing user or place reference");

    const [userResult, placeResult] = await Promise.all([
      db.fetchRecords({ recordNames: [userRecordName] }),
      db.fetchRecords({ recordNames: [placeRecordName] })
    ]);
    const user = userResult.records[0];
    const place = placeResult.records[0];

    // Fetch Top10PhotoEntries
    const photosQuery = await db.performQuery({
      recordType: 'Top10PhotoEntries',
      filterBy: [
        { fieldName: 'user', comparator: 'EQUALS', fieldValue: { value: { recordName: user.recordName } } },
        { fieldName: 'place', comparator: 'EQUALS', fieldValue: { value: { recordName: place.recordName } } }
      ]
    });
    const photos = photosQuery.records;

    // Update header
    document.getElementById("place-name").innerText = `${place.fields.name.value}, ${place.fields.state.value}, ${place.fields.country.value}`;
    document.getElementById("trip-subtitle").innerText = `Explorer: ${user.fields.username.value}`;

    const content = document.getElementById("content");
    content.innerHTML = "";

    // Trip card
    const tripCard = document.createElement("div");
    tripCard.className = "trip-card";
    tripCard.innerHTML = `
      <div class="trip-header">
        <div>
          <div class="trip-title">${place.fields.name.value}</div>
          <div class="trip-username">${user.fields.username.value}</div>
        </div>
      </div>
      <div class="trip-stats">
        <div class="stat-card"><div class="stat-number">${photos.length}</div><div class="stat-label">Photos</div></div>
      </div>
    `;
    content.appendChild(tripCard);

    // Group photos by category
    const grouped = {};
    photos.forEach(p => {
      const cat = p.fields.category?.value || "Uncategorized";
      if (!grouped[cat]) grouped[cat] = [];
      grouped[cat].push(p);
    });

    const section = document.createElement("div");
    section.className = "categories-section";
    section.innerHTML = `<h2 class="section-title">Trip Highlights</h2><div class="categories-grid"></div>`;
    const grid = section.querySelector(".categories-grid");

    for (const [cat, entries] of Object.entries(grouped)) {
      const card = document.createElement("div");
      card.className = "category-card";
      card.innerHTML = `
        <div class="carousel-container">
          <img src="${entries[0].fields.photoData?.value?.downloadURL || ''}" class="carousel-image" alt="">
        </div>
        <div class="category-content">
          <div class="category-name">${cat}</div>
          <div class="captions-container">
            ${entries.map(e => `<div class="caption-item">${e.fields.caption?.value || ''}</div>`).join("")}
          </div>
        </div>
      `;
      grid.appendChild(card);
    }

    content.appendChild(section);

  } catch (err) {
    console.error(err);
    document.getElementById("content").innerHTML = `<div class="error">Failed to load trip data: ${err.message}</div>`;
  }
}

loadTrip();
</script>
</body>
</html>
